---
import "../styles/login-register.css";
import background from "../assets/background_kursi_kerajaan.png";
import logo from "../assets/logo.png";
import paperScroll from "../assets/paper_scroll.png";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Code Quest</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;700&display=swap" rel="stylesheet" />
  </head>

  <body>
    <!-- BACKGROUND IMAGE -->
    <div class="background-container">
      <img src={background.src} alt="Background" class="background-img" />
    </div>

    <!-- DASHBOARD LAYOUT -->
    <div class="dashboard-layout">
      <!-- Mobile Toggle -->
      <button id="mobileToggle" class="mobile-nav-toggle">â˜°</button>

      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
          <img src={logo.src} alt="Logo" />
        </div>

        <nav class="sidebar-nav">
          <button class="nav-item active" data-section="profile">
            <span>ðŸ‘¤</span> Profile Tim
          </button>
          <button class="nav-item" data-section="timeline">
            <span>ðŸ“…</span> Timeline
          </button>
        </nav>

        <div class="sidebar-footer">
          <button class="nav-item nav-logout" id="logoutBtn">
            <span>ðŸšª</span> Logout
          </button>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="main-container">
        <!-- LOADING STATE -->
        <div id="loadingState" class="scroll-content">
          <h1 class="login-title">LOADING...</h1>
        </div>

        <!-- PROFILE SECTION -->
        <section id="profileSection" class="dashboard-section active">
          <div class="scroll-container">
            <img src={paperScroll.src} alt="Scroll" class="scroll-bg" />
            <div class="scroll-content">
              <h1 class="login-title">PROFIL TIM</h1>
              <div id="teamBadge" class="leader-type" style="margin-top: 20px;"></div>
              
              <div class="dashboard-grid">
                <div class="dashboard-item">
                  <div class="dashboard-label">GROUP NAME</div>
                  <div class="dashboard-value" id="groupName"></div>
                </div>
                <div class="dashboard-item">
                  <div class="dashboard-label">LEADER NAME</div>
                  <div class="dashboard-value" id="leaderName"></div>
                </div>
                <div class="dashboard-item">
                  <div class="dashboard-label">EMAIL</div>
                  <div class="dashboard-value" id="leaderEmail"></div>
                </div>
                <div class="dashboard-item">
                  <div class="dashboard-label">WHATSAPP</div>
                  <div class="dashboard-value" id="leaderWhatsapp"></div>
                </div>
                <div class="dashboard-item">
                  <div class="dashboard-label">LINE ID</div>
                  <div class="dashboard-value" id="leaderLine"></div>
                </div>
                <div class="dashboard-item">
                  <div class="dashboard-label">GITHUB ID</div>
                  <div class="dashboard-value" id="leaderGithub"></div>
                </div>
                <div class="dashboard-item" style="grid-column: span 2;">
                  <div class="dashboard-label">CONTACT PERSON</div>
                  <div class="dashboard-value" id="contactPerson">Loading...</div>
                </div>
              </div>

              <div class="dashboard-actions">
                <a id="viewCv" href="#" target="_blank" class="view-btn">ðŸ“„ View CV</a>
                <a id="viewIdCard" href="#" target="_blank" class="view-btn">ðŸªª View ID Card</a>
              </div>
            </div>
          </div>
        </section>

        <!-- TIMELINE SECTION -->
        <section id="timelineSection" class="dashboard-section">
          <div class="scroll-container">
            <img src={paperScroll.src} alt="Scroll" class="scroll-bg" />
            <div class="scroll-content">
              <h1 class="login-title">TIMELINE</h1>
              <div id="timelineContainer" class="dashboard-timeline">
                <!-- Timeline items injected here -->
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- LOGOUT MODAL -->
    <div id="logoutModal" class="modal-overlay">
      <div class="modal-content">
        <h2 class="modal-title">Confirm Logout</h2>
        <p class="modal-text">Apakah Anda yakin ingin logout?</p>
        <div class="modal-buttons">
          <button id="confirmLogout" class="submit-btn" style="font-size: 1.2rem; padding: 10px 20px; margin: 0;">Ya</button>
          <button id="cancelLogout" class="secondary-btn" style="font-size: 1.2rem; padding: 10px 20px; margin: 0;">Tidak</button>
        </div>
      </div>
    </div>

    <script is:inline>
      document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/login";
          return;
        }

        const sections = {
          profile: document.getElementById("profileSection"),
          timeline: document.getElementById("timelineSection")
        };
        const navItems = document.querySelectorAll(".nav-item[data-section]");
        const loadingState = document.getElementById("loadingState");
        const sidebar = document.getElementById("sidebar");
        const mobileToggle = document.getElementById("mobileToggle");

        // Section Switching
        navItems.forEach(item => {
          item.addEventListener("click", () => {
            const target = item.getAttribute("data-section");
            
            // Update active states
            navItems.forEach(nav => nav.classList.remove("active"));
            item.classList.add("active");

            // Update visible sections
            Object.keys(sections).forEach(key => {
              sections[key].classList.toggle("active", key === target);
            });

            // Close sidebar on mobile after click
            if (window.innerWidth <= 1024) {
              sidebar.classList.remove("active");
            }
          });
        });

        // Mobile Toggle
        mobileToggle.addEventListener("click", () => {
          sidebar.classList.toggle("active");
        });

        try {
          const res = await fetch("http://localhost:5001/api/dashboard", {
            headers: { "Authorization": `Bearer ${token}` }
          });

          if (!res.ok) throw new Error("Failed to fetch dashboard data");

          const data = await res.json();
          
          // Fill Profile Data
          document.getElementById("groupName").textContent = data.groupName;
          document.getElementById("teamBadge").textContent = data.status;
          
          if (data.leader) {
            document.getElementById("leaderName").textContent = data.leader.fullName;
            document.getElementById("leaderEmail").textContent = data.leader.email;
            document.getElementById("leaderWhatsapp").textContent = data.leader.whatsappNumber;
            document.getElementById("leaderLine").textContent = data.leader.lineId;
            document.getElementById("leaderGithub").textContent = data.leader.githubId;
            
            const birthDate = new Date(data.leader.birthDate).toLocaleDateString('en-GB', {
              day: '2-digit', month: 'long', year: 'numeric'
            });
            document.getElementById("leaderBirth").textContent = `${data.leader.birthPlace}, ${birthDate}`;

            if (data.leader.cvUrl) {
              document.getElementById("viewCv").href = data.leader.cvUrl.startsWith('http') ? data.leader.cvUrl : `http://localhost:5001${data.leader.cvUrl}`;
            }
            if (data.leader.idCardUrl) {
              document.getElementById("viewIdCard").href = data.leader.idCardUrl.startsWith('http') ? data.leader.idCardUrl : `http://localhost:5001${data.leader.idCardUrl}`;
            }
          }

          // Fill Contact Person
          if (data.socials) {
            const contact = data.socials.find(s => s.name === 'contact_person');
            if (contact) {
              document.getElementById("contactPerson").textContent = contact.account;
            } else {
              document.getElementById("contactPerson").textContent = "-";
            }
          }

          // Fill Timeline Data
          const timelineContainer = document.getElementById("timelineContainer");
          if (data.timelines && data.timelines.length > 0) {
            data.timelines.forEach(item => {
              const div = document.createElement("div");
              div.className = "timeline-mini-item";
              div.innerHTML = `
                <div class="timeline-mini-date">${item.date}</div>
                <div class="timeline-mini-event">${item.event}</div>
              `;
              timelineContainer.appendChild(div);
            });
          }

          loadingState.style.display = "none";
        } catch (err) {
          console.error(err);
          localStorage.removeItem("token");
          window.location.href = "/login";
        }

        // Logout Logic
        const logoutModal = document.getElementById("logoutModal");
        document.getElementById("logoutBtn").addEventListener("click", () => logoutModal.classList.add("active"));
        document.getElementById("cancelLogout").addEventListener("click", () => logoutModal.classList.remove("active"));
        document.getElementById("confirmLogout").addEventListener("click", () => {
          localStorage.clear();
          window.location.href = "/";
        });
      });
    </script>
  </body>
</html>
